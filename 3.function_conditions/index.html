
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Genomics Aotearoa">
      
      
        <link rel="canonical" href="https://genomicsaotearoa.github.io/Intermediate-R/3.function_conditions/">
      
      
        <link rel="prev" href="../2.relational_data/">
      
      
        <link rel="next" href="../4.iterations/">
      
      
      <link rel="icon" href="../theme_figures/nesi_ga.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Functions and conditional statements - Intermediate R</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mukta:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Mukta";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#functions-and-conditional-statements" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
<!-- Original Header -->


  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Intermediate R" class="md-header__button md-logo" aria-label="Intermediate R" data-md-component="logo">
      
  <img src="../theme_figures/nesi_ga.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Intermediate R
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Functions and conditional statements
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/GenomicsAotearoa/Intermediate-R" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GenomicsAotearoa/Intermediate-R
  </div>
</a>
      </div>
    
  </nav>
  
</header>

    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Intermediate R" class="md-nav__button md-logo" aria-label="Intermediate R" data-md-component="logo">
      
  <img src="../theme_figures/nesi_ga.png" alt="logo">

    </a>
    Intermediate R
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/GenomicsAotearoa/Intermediate-R" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GenomicsAotearoa/Intermediate-R
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../0.prep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    An introduction to the data
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.string_manipulation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    String manipulation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.relational_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Relational data
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Functions and conditional statements
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Functions and conditional statements
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#anatomy-of-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Anatomy of functions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#control-flow-1-conditional-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Control flow 1: Conditional execution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Control flow 1: Conditional execution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vectorised-conditional-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Vectorised conditional execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alpha-diversity" class="md-nav__link">
    <span class="md-ellipsis">
      Alpha diversity
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Alpha diversity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-small-richness" class="md-nav__link">
    <span class="md-ellipsis">
      Starting small: richness
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-arguments-shannons-and-simpsonss-diversity" class="md-nav__link">
    <span class="md-ellipsis">
      Adding arguments: Shannon's and Simpsons's diversity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting-and-refining-code" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting and refining code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defending-our-function" class="md-nav__link">
    <span class="md-ellipsis">
      Defending our function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#improve-function-design" class="md-nav__link">
    <span class="md-ellipsis">
      Improve function design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Improve function design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-other-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Read other functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-early" class="md-nav__link">
    <span class="md-ellipsis">
      return() early
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switch-evaluations-depending-on-argument-input" class="md-nav__link">
    <span class="md-ellipsis">
      switch() evaluations depending on argument input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#think-of-the-users" class="md-nav__link">
    <span class="md-ellipsis">
      Think of the users
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#break-your-own-code" class="md-nav__link">
    <span class="md-ellipsis">
      Break your own code!
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../4.iterations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Iterations
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../5.data_structures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data structures
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Supplementary
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Supplementary
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Supplementary/s1.seq_prep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sequence processing for Intermediate R workshop
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Supplementary/s2.dat_prep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data preparation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#anatomy-of-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Anatomy of functions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#control-flow-1-conditional-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Control flow 1: Conditional execution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Control flow 1: Conditional execution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vectorised-conditional-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Vectorised conditional execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alpha-diversity" class="md-nav__link">
    <span class="md-ellipsis">
      Alpha diversity
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Alpha diversity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#starting-small-richness" class="md-nav__link">
    <span class="md-ellipsis">
      Starting small: richness
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-arguments-shannons-and-simpsonss-diversity" class="md-nav__link">
    <span class="md-ellipsis">
      Adding arguments: Shannon's and Simpsons's diversity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting-and-refining-code" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting and refining code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defending-our-function" class="md-nav__link">
    <span class="md-ellipsis">
      Defending our function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#improve-function-design" class="md-nav__link">
    <span class="md-ellipsis">
      Improve function design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Improve function design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-other-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Read other functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-early" class="md-nav__link">
    <span class="md-ellipsis">
      return() early
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switch-evaluations-depending-on-argument-input" class="md-nav__link">
    <span class="md-ellipsis">
      switch() evaluations depending on argument input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#think-of-the-users" class="md-nav__link">
    <span class="md-ellipsis">
      Think of the users
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#break-your-own-code" class="md-nav__link">
    <span class="md-ellipsis">
      Break your own code!
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="functions-and-conditional-statements">Functions and conditional statements<a class="headerlink" href="#functions-and-conditional-statements" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Learning objectives</p>
<ul>
<li>Identify parts of a function</li>
<li>Write custom functions</li>
<li>Use conditional statements to control outputs</li>
<li>Refine functions to improve efficiency</li>
<li>Access function source code from other packages</li>
</ul>
</div>
<h2 id="anatomy-of-functions">Anatomy of functions<a class="headerlink" href="#anatomy-of-functions" title="Permanent link">&para;</a></h2>
<p>It's not a secret that for as long you've used R, you've been using functions. Here, we're going to make them! Functions are, like all things in R, a type of object (implications discussed in a <a href="../5.data_structures/#recursive-objects-functions">later episode</a>). They are the "verbs" of the R programming language where, instead of storing data, functions store code that defines how it behaves and operates on other objects.</p>
<p>In an R script, functions are created and assigned using the following syntax:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="o">&lt;</span><span class="n">arguments</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">do_something</span><span class="o">&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">}</span>
</code></pre></div>
<p>Lets break down the anatomy of the pseudocode:</p>
<ul>
<li><code>f</code> is the assigned name of the function.</li>
<li><code>function()</code> initialises a function call, telling R that<ul>
<li>We are writing a function</li>
<li>Anything inside round brackets are arguments for the function</li>
<li>Anything after the closing round bracket and on the same line is the code that defines the function</li>
</ul>
</li>
<li><code>{   &lt;do_something&gt;   }</code> is the expression that defines how the function works</li>
</ul>
<p>Let's write a function to give some context as to what each part does.</p>
<div class="arithmatex">\[
f(x) = \sqrt{2(x + 1)}
\]</div>
<p>The above is an equation for a function called <span class="arithmatex">\(f\)</span> that takes a value <span class="arithmatex">\(x\)</span> as input and outputs a value based on <span class="arithmatex">\(x\)</span>. We can translate that into R code:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">f1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nf">sqrt</span><span class="p">(</span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">))</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Here, we've "wrapped" an arithmetic operation in a function.</p>
<div class="admonition tip">
<p class="admonition-title">Alternative syntax</p>
<p>We can also use a shorthand for the <code>function()</code> call by replacing <code>function</code> with a <code>\</code>:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">f1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span>\<span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">))</span>
</code></pre></div>
</div>
<p>This syntax is useful for on-the-fly functions that can be applied <a href="#iterations">using <code>map()</code> functions</a>.</p>
<p>Notice also that the function expression is on the same line as the function call. This syntax is acceptable for short expressions but not encouraged for longer ones.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Infix functions</p>
<p>Most objects we think of as functions are <strong><em>prefix</em></strong> functions, where arguments are placed after the function call. However, there are also <strong><em>infix</em></strong> functions, where arguments are placed on either side of the function call. For example:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">3</span>
</code></pre></div>
</div>
<p>Both <code>&lt;-</code> and <code>+</code> are infix functions for assignment and addition, respectively. All basic arithmetic (e.g., <code>+</code>, <code>-</code>, <code>*</code>, and <code>/</code>), assignment (including <code>=</code>), logical (e.g., <code>|</code>, <code>&amp;</code>, <code>&amp;&amp;</code>, etc.), and relational (e.g., <code>&gt;</code>, <code>!=</code>, <code>==</code>, etc.) operators are primitive (i.e., foundational part of the language) infix functions.</p>
<p>The pipe operator <code>%&gt;%</code> introduced by the <code>magrittr</code> package is a user-generated infix function. As this is a custom infix function, the <code>%</code> that surrounds the operator is necessary. It does not have to be a symbol or operator and can be represented by anything really, (e.g., <code>%in%</code>) even <a href="https://colinfay.me/playing-r-infix-functions/">emojis</a>!</p>
<p>We can define our own infix function:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span>
<span class="normal"><a href="#__codelineno-4-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">`%&lt;I&gt;%`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="c1"># Get the minima from the left hand side and the maxima from the right hand side</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nf">c</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">rhs</span><span class="p">))</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="p">}</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="nf">rnorm</span><span class="p">(</span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="o">%&lt;I&gt;%</span><span class="w"> </span><span class="nf">rnorm</span><span class="p">(</span><span class="m">200</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
<h2 id="control-flow-1-conditional-execution">Control flow 1: Conditional execution<a class="headerlink" href="#control-flow-1-conditional-execution" title="Permanent link">&para;</a></h2>
<p>We will take a little detour from functions to learn about control flow. These are constructs that code for <strong><em>decision making</em></strong> (this episode) and <strong><em>repetition</em></strong> (next episode). Decision making/conditional execution helps to direct the "flow" of operations using Boolean logic (<code>TRUE</code>/<code>FALSE</code>). In R, conditional execution is coded using <code>if-else</code> statments:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span>
<span class="normal"><a href="#__codelineno-5-5">5</a></span>
<span class="normal"><a href="#__codelineno-5-6">6</a></span>
<span class="normal"><a href="#__codelineno-5-7">7</a></span>
<span class="normal"><a href="#__codelineno-5-8">8</a></span>
<span class="normal"><a href="#__codelineno-5-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">predicate</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">expression_1</span><span class="o">&gt;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">expression_2</span><span class="o">&gt;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The pseudocode above means <code>if</code> the <code>&lt;predicate&gt;</code> is (or returns a) <code>TRUE</code>, execute <code>&lt;expression_1&gt;</code>, otherwise execute <code>&lt;expression_2&gt;</code>.</p>
<p>For example:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;x is less than 10&quot;</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;x is more than 10&quot;</span><span class="p">)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="admonition note">
<p class="admonition-title">Predicate and predicate functions</p>
<p>A predicate is a statement or function that evaluates and returns <strong>one</strong> <code>TRUE</code> or <code>FALSE</code> value. For example, this is a predicate that evaluates if <code>x</code> is larger than 5:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">5</span>
</code></pre></div>
<p>If we set <code>x &lt;- 10</code>, the code will return a <code>TRUE</code>.</p>
<p>R has many built-in predicate functions (i.e., functions that evaluate a statement or object and returns a <code>TRUE</code>/<code>FALSE</code>). They are often prefixed using <code>is.&lt;something&gt;()</code>. For example:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">9</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">tim</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;Tim is eating&quot;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">6</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="c1"># Predicate function</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="nf">is.character</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="nf">is.character</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="nf">is.character</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="nf">is.numeric</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Notice that regardless of the length of the vector, the predicate functions return only one Boolean variable. This is important for conditional statements as it can only evaluate predicates and not a vector of Boolean variables.</p>
</div>
<p>The <code>else</code> statement is optional (and often unnecessary). The expression will not be evaluated if the predicate returns <code>FALSE</code>.</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span>
<span class="normal"><a href="#__codelineno-9-7">7</a></span>
<span class="normal"><a href="#__codelineno-9-8">8</a></span>
<span class="normal"><a href="#__codelineno-9-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1"># Predicate returns TRUE, expression is evaluated</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;x is less than 10&quot;</span><span class="p">)</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="p">}</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="c1"># Predicate returns FALSE, expression is not evaluated</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;x is greater than 10&quot;</span><span class="p">)</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<p>For complex predicate evaluations (e.g., intermediate thresholds) or evaluations that lead to different paths (e.g., hierarchical decision making), we can chain and/or nest multiple statments together:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">predicate_1</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">expression_1</span><span class="o">&gt;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">predicate_2</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># Chained statements: an if-else after an if-else</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">predicate_2a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># Nested statements: an if-else inside and if-else</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="o">&lt;</span><span class="n">expression_2a</span><span class="o">&gt;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">    </span><span class="o">&lt;</span><span class="n">expression_2b</span><span class="o">&gt;</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">expression_3</span><span class="o">&gt;</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="p">}</span>
</code></pre></div>
<h3 id="vectorised-conditional-execution">Vectorised conditional execution<a class="headerlink" href="#vectorised-conditional-execution" title="Permanent link">&para;</a></h3>
<p>The above conditional statements only operate when there is only one Boolean value. What if we wanted to generate different outcomes depending on the elements in a vector? In this case, we can use these two functions depending on how many outcomes we need:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Binary outcomes</label><label for="__tabbed_1_2">Multiple conditions and outcomes</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>If we needed one outcome each for <code>TRUE</code> or <code>FALSE</code>, we can use <code>if_else()</code>, a vectorised if-else statement that evaluates a Boolean vector (or a condition that returns one) and produces outcomes depending on whether each element is a TRUE or FALSE. For example:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span>
<span class="normal"><a href="#__codelineno-11-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">fridge</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;banana&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;apple&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;kale&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;durian&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pear&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;spinach&quot;</span><span class="p">)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="nf">if_else</span><span class="p">(</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="n">fridge</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">fruit</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">  </span><span class="nf">str_c</span><span class="p">(</span><span class="nf">str_to_upper</span><span class="p">(</span><span class="n">fridge</span><span class="p">),</span><span class="w"> </span><span class="s">&quot; is a fruit&quot;</span><span class="p">),</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">  </span><span class="nf">str_c</span><span class="p">(</span><span class="n">fridge</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; is not a fruit&quot;</span><span class="p">)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Base R equivalent: <code>ifelse()</code></p>
<p>Base R also has a similar implementation: <code>ifelse()</code>. However, <code>dplyr::if_else()</code> strictly preserves the data type (e.g., the output will not be coerced to a character if the input is a factor) and can evaluate missing values; <code>base::ifelse()</code> does not enforce data type preservation and returns missing values when it encounters them.</p>
</div>
</div>
<div class="tabbed-block">
<p>If we required different outcomes based on multiple, hierarchical conditions, we can use <code>case_when()</code>, a general vectorised if-else analogous to chained if-else statements. For example:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">fridge</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;cheese&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fridge</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;milk&quot;</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="n">dairy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;cheese&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;yoghurt&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;butter&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;milk&quot;</span><span class="p">)</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="n">vegetable</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;beetroot&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;beans&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;kale&quot;</span><span class="p">)</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="nf">case_when</span><span class="p">(</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">  </span><span class="n">fridge</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">fruit</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="nf">str_c</span><span class="p">(</span><span class="n">fridge</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; is a fruit&quot;</span><span class="p">),</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">  </span><span class="n">fridge</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">vegetable</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="nf">str_c</span><span class="p">(</span><span class="n">fridge</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; is a vegetable&quot;</span><span class="p">),</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">  </span><span class="n">fridge</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">dairy</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="nf">str_c</span><span class="p">(</span><span class="n">fridge</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; is a dairy product&quot;</span><span class="p">),</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">  </span><span class="n">.default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">str_glue</span><span class="p">(</span><span class="s">&quot;You don&#39;t even like {fridge}!&quot;</span><span class="p">)</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<h2 id="alpha-diversity">Alpha diversity<a class="headerlink" href="#alpha-diversity" title="Permanent link">&para;</a></h2>
<p>Time to apply all of the above to write a function! For this section, we will be writing a function that calculates the <span class="arithmatex">\(\alpha\)</span>-diversity (a measure local diversity) of a sample. The simplest measure is richness (often denoted <span class="arithmatex">\(q\)</span> or <span class="arithmatex">\(S\)</span>), which represents the <em>number of species/taxonomic units</em>. While richness is simple and intuitive to understand, it is heavily biased by rare members of the sample community. This is always the case with microbiome data. Other <span class="arithmatex">\(\alpha\)</span>-diversity indices were constructed to account for the uneven distribution of taxonomic units by incorporating relative abundance information. Popular options are:</p>
<p><strong>Shannon's index,</strong> <span class="arithmatex">\(H\)</span></p>
<div class="arithmatex">\[
H = -\sum_{i=1}^{q} p_{i} \log p_{i}
\]</div>
<p>Where <span class="arithmatex">\(p_{i}\)</span> is the proportion (or relative frequency) of the <span class="arithmatex">\(i^{th}\)</span> organism relative to the sample total.</p>
<p><strong>Simpson's diversity,</strong> <span class="arithmatex">\(D\)</span></p>
<div class="arithmatex">\[
D = \frac{1}{\lambda}
\]</div>
<p>Where the <span class="arithmatex">\(\lambda\)</span> is Simpson's concentration index, defined as</p>
<div class="arithmatex">\[
\lambda = \sum_{i=1}^{q} p_{i}^2
\]</div>
<p>For the mathematically inclined, you might observe that these indices:</p>
<ul>
<li>Gives more weight to abundant taxa (<span class="arithmatex">\(D\)</span> moreso than <span class="arithmatex">\(H\)</span>)</li>
<li>Reach their maxima when all taxa are exactly evenly distributed in the sample</li>
<li>Reach their minima when one taxa is dominant</li>
<li>Are not on the same scale (<span class="arithmatex">\(H\)</span> is on a log scale, <span class="arithmatex">\(q\)</span> and <span class="arithmatex">\(D\)</span> are on the "number of taxonomic units" scale)</li>
</ul>
<p>For now, it is enough to know that they are mathematical formulas that we are going to translate into code.</p>
<h3 id="starting-small-richness">Starting small: richness<a class="headerlink" href="#starting-small-richness" title="Permanent link">&para;</a></h3>
<p>We will start by writing a function to calculate richness (the number of taxonomic units in the sample). Applied in R, this means the number of non-zero elements in a numeric vector.</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1"># Test vector</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="n">test_vector</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">asv</span><span class="o">$</span><span class="n">AS1A3</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="c1"># Richness</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="n">calc_alpha_diversity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">  </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="p">}</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="c1"># Test function</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_vector</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<h3 id="adding-arguments-shannons-and-simpsonss-diversity">Adding arguments: Shannon's and Simpsons's diversity<a class="headerlink" href="#adding-arguments-shannons-and-simpsonss-diversity" title="Permanent link">&para;</a></h3>
<p>Next, lets add the other indices to be part of the function. We will use conditional execution to control output depending on the index is requested.</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span>
<span class="normal"><a href="#__codelineno-14-22">22</a></span>
<span class="normal"><a href="#__codelineno-14-23">23</a></span>
<span class="normal"><a href="#__codelineno-14-24">24</a></span>
<span class="normal"><a href="#__codelineno-14-25">25</a></span>
<span class="normal"><a href="#__codelineno-14-26">26</a></span>
<span class="normal"><a href="#__codelineno-14-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">calc_alpha_diversity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">  </span><span class="c1"># Richness</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">  </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">  </span><span class="c1"># Shannon&#39;s index</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">  </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">  </span><span class="c1"># Simpson&#39;s diversity</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">  </span><span class="n">D</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="p">}</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a><span class="c1"># Test that it works</span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_vector</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_vector</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_vector</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Here, we're calculating all possible outcomes, then returning values based on the index requested.</p>
<div class="admonition tip">
<p class="admonition-title"><code>return()</code></p>
<p>The <code>return()</code> function returns/outputs the value specified in it and stops evaluation of any code below it. In <code>calc_alpha_diversity()</code>, if the index requested is richness, and subsequent code to calculate the other indices are not evaluated. In the case where a function code has no <code>return()</code>, the function will output the last evaluation.</p>
</div>
<p>The function we wrote works for <span class="arithmatex">\(q\)</span> and <span class="arithmatex">\(D\)</span>, but not for <span class="arithmatex">\(H\)</span>. Lets revise that.</p>
<h3 id="troubleshooting-and-refining-code">Troubleshooting and refining code <img alt="🔧" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f527.svg" title=":wrench:" /><a class="headerlink" href="#troubleshooting-and-refining-code" title="Permanent link">&para;</a></h3>
<p>Lets troubleshoot our function first. Why did the code not work for Shannon's index?</p>
<div class="admonition warning">
<p class="admonition-title">A little math</p>
<p><code>log(0)</code> is undefined. However, in R, it is given the value <code>-Inf</code> for bases &gt; 0 and <code>Inf</code> for bases \&lt; 0. If any <code>p</code> is 0, the operation <code>0 * log(0)</code> will return <code>NaN</code> (Not a Number). Therefore, the summation of that will return <code>NA</code>.</p>
</div>
<p>We will also consider other areas for refinement:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:4"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><input id="__tabbed_2_4" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Repeatedly assigning <code>p</code></label><label for="__tabbed_2_2">Assigning <code>H</code> and <code>D</code></label><label for="__tabbed_2_3">Chained if-else</label><label for="__tabbed_2_4">Choice of logarithm base</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Relative frequency <code>p</code> is not required for richness calculations and is shared for calculations of Shannon's and Simpson's indices.</p>
</div>
<div class="tabbed-block">
<p>Assigning of <span class="arithmatex">\(H\)</span> and <span class="arithmatex">\(D\)</span> helps us, the human, to differentiate the indices in mathematical notation. However, R does not care which name is used. The decision to return either index is already managed by conditional statements.</p>
</div>
<div class="tabbed-block">
<p>Chained statements are not necessary here. Conditional execution (and <code>return()</code>) should occur earlier to prevent unnecessary code evaluation.</p>
</div>
<div class="tabbed-block">
<p>Some people may have a reason to use another base for the <code>log()</code> function used in calculating Shannon's index. While the natural logarithm (log in base <span class="arithmatex">\(e\)</span>) is often the default choice, there should be an option to change that if desired. To set a default value in a custom function, add the desired value to the argument within the function call (see below).</p>
</div>
</div>
</div>
<p>With that, lets revise the function:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span>
<span class="normal"><a href="#__codelineno-15-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">calc_alpha_diversity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">  </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">  </span><span class="n">log.base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1"># Provide natural logarithm as default</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">  </span><span class="c1"># Richness</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">  </span><span class="c1"># Relative frequency</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">  </span><span class="c1"># Shannon&#39;s index</span>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log.base</span><span class="p">),</span><span class="w"> </span><span class="c1"># Provide option for changing log base</span>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">               </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">                </span><span class="c1"># Removes NA prior to summation</span>
<a id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-15-19" name="__codelineno-15-19"></a>
<a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<a id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-15-23" name="__codelineno-15-23"></a>
<a id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="w">  </span><span class="n">H</span>
<a id="__codelineno-15-25" name="__codelineno-15-25"></a>
<a id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="p">}</span>
<a id="__codelineno-15-27" name="__codelineno-15-27"></a>
<a id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="c1"># Test the function</span>
<a id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_vector</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span>
<a id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_vector</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span>
<a id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_vector</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<p>It works! Note that without a return, the function simply outputs the last evaluted code (in this case, this is the value <code>H</code>).</p>
<h3 id="defending-our-function">Defending our function <img alt="🛡" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f6e1.svg" title=":shield:" /><a class="headerlink" href="#defending-our-function" title="Permanent link">&para;</a></h3>
<p>What would happen if we used our functions with non-ideal inputs? For this, we will take hints from the concepts in <strong>defensive programming</strong>. Defensive programming is more about design choices than cybersecurity, where we approach designing code that:</p>
<ul>
<li>Has predictable outputs, regardless of inputs</li>
<li>"Fails fast", thus saving time and computational resources</li>
<li>Reads well, so others can audit the code and understand what each line is doing</li>
</ul>
<p>Can you identify some scenarios where our function might not do so well?</p>
<details class="warning">
<summary>Pitfalls and food for thought</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="3:3"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><input id="__tabbed_3_3" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Missing values</label><label for="__tabbed_3_2">Negative numbers</label><label for="__tabbed_3_3">Non-numeric data</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><strong>What does <code>NA</code> mean?</strong></p>
<p>Lets consider how these tables were constructed. They were originally sequences that were processed by a software and then reads were counted for each taxonomic unit. If a taxonomic unit was not found in a particular sample read file, the software would have returned a 0. Therefore, <code>NA</code> could not have arisen from processing this particular batch.</p>
<p>However, we can imagine a scenario where <code>NA</code> could be introduced from a joining step during data cleaning or pre-processing. This can happen when processing samples by batches.</p>
<p>Critically, regardless of the reasons for missingness, is a missing count functionally equivalent to 0?</p>
<p><strong>What is the effect of <code>NA</code>?</strong></p>
<p>We used <code>sum()</code> quite often in the code. Furthermore, we even added <code>na.rm = TRUE</code> in the expression used to calculate Shannon's index to account for the <code>NA</code> introduced when evaluating <span class="arithmatex">\(0 \log 0\)</span>. Would we handle <code>NA</code> in all parts where <code>sum()</code> is used in this way?</p>
</div>
<div class="tabbed-block">
<p><strong>Do negative numbers make sense?</strong></p>
<p>Remember that this is a table of counts. What do negative numbers mean in that context? Does it make sense?</p>
<p><strong>How does the function handle negative numbers?</strong></p>
<p><span class="arithmatex">\(q\)</span> would ignore negative numbers. If the negative counts were an oversight or accidental, it would result in an undercount of richness.</p>
<p><span class="arithmatex">\(H\)</span> would not produce a numeric output (the log of a negative number is undefined).</p>
<p><span class="arithmatex">\(D\)</span> would be an underestimate (the sum would be an undercount of the whole).</p>
</div>
<div class="tabbed-block">
<p><strong>Does non-numeric data make sense for this function?</strong></p>
<p>These indices are meant for count data (i.e., numeric data). Suppose that human error led to the mis-typing of inputs, would we want to coerce the data into numeric type using <code>as.numeric()</code>? Are we guessing the intentions and errors of the user? Coercing characters that are not numbers will cause <code>as.numeric()</code> to return <code>NA</code>.</p>
<p><strong>Is it fit for purpose?</strong></p>
<p>We established that the function is meant to provide information only on numeric data. Albeit being a small function that runs quickly, we can imagine a scenario where we might either (1) write a function that has many complex steps or (2) run a substantially larger data set through the diversity function. In either scenario, would we want to spend time and computational resources on non-target inputs?</p>
</div>
</div>
</div>
</details>
<p>Let's test our function through these non-ideal scenarios. Create vectors with non-ideal properties and try them on the current version of the function.</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1"># Randomly introduce NA</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="n">test_missing</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">test_vector</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="n">test_missing</span><span class="p">[</span><span class="nf">sample.int</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">test_missing</span><span class="p">),</span><span class="w"> </span><span class="m">5</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="c1"># Randomly introduce negative numbers</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="n">test_negative</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">  </span><span class="n">test_vector</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nf">runif</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">test_vector</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0.95</span><span class="p">,</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">  </span><span class="o">-</span><span class="n">test_vector</span><span class="p">,</span><span class="w"> </span><span class="n">test_vector</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="p">)</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="c1"># Coerce to character</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="n">test_character</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">test_vector</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Random replacements</p>
<p>The code above uses two ways to generate replacements at random. In line 3, a random sampler <code>sample.int()</code> was used to indicate 5 random indices to which we wanted to inject <code>NA</code>. In lines 6-9, a conditional statement was constructed to replace positive, non-zero values, picked based on a numeric (double) vector picked from a uniform distribution, with negative equivalents.</p>
</div>
<p>With those pitfalls in mind, we will need to make some design decisions and implement them in code. Here are my choices:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Remove missing values</label><label for="__tabbed_4_2"><em>Error</em> on negative numbers and non-numeric data</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Functionally, they are the same as not observing a taxa in a sample (equivalent to 0). <em>Warn</em> the user when this happens but continue with evaluating input.</p>
</div>
<div class="tabbed-block">
<p>These data types are not intended for use with diversity indices here. Lets not spend computing time and resources on them. To achieve this, we will "error out" of the function where if negative numbers and non-numeric data are encountered, the function will stop further computation and produce an error message.</p>
</div>
</div>
</div>
<p>Feel free to implement your own design choices by modifying the code below!</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span>
<span class="normal"><a href="#__codelineno-17-32">32</a></span>
<span class="normal"><a href="#__codelineno-17-33">33</a></span>
<span class="normal"><a href="#__codelineno-17-34">34</a></span>
<span class="normal"><a href="#__codelineno-17-35">35</a></span>
<span class="normal"><a href="#__codelineno-17-36">36</a></span>
<span class="normal"><a href="#__codelineno-17-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">calc_alpha_diversity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">  </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">  </span><span class="n">log.base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1"># Natural logarithm as default</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">  </span><span class="c1"># Warn for missing values</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">anyNA</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">    </span><span class="nf">warning</span><span class="p">(</span><span class="s">&quot;x contains NAs which are removed prior to calculations.&quot;</span><span class="p">)</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">  </span><span class="c1"># Error on non-numeric and negative data</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.numeric</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">any</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="w">    </span><span class="nf">stop</span><span class="p">(</span><span class="s">&quot;x must be positive numeric values!&quot;</span><span class="p">)</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="w">  </span><span class="c1"># Richness</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="w">  </span><span class="c1"># Relative frequency</span>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">  </span><span class="c1"># Shannon&#39;s index</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log.base</span><span class="p">),</span><span class="w"> </span><span class="c1"># Provide option for changing log base</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="w">               </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">                </span><span class="c1"># Removes NA from 0 * log(0)</span>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a>
<a id="__codelineno-17-31" name="__codelineno-17-31"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-32" name="__codelineno-17-32"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<a id="__codelineno-17-33" name="__codelineno-17-33"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-17-34" name="__codelineno-17-34"></a>
<a id="__codelineno-17-35" name="__codelineno-17-35"></a><span class="w">  </span><span class="n">H</span>
<a id="__codelineno-17-36" name="__codelineno-17-36"></a>
<a id="__codelineno-17-37" name="__codelineno-17-37"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Try the new function on the test vectors:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_missing</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_negative</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="nf">calc_alpha_diversity</span><span class="p">(</span><span class="n">test_character</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<!-- 
Could add a sub-section on recursive functions using a limited integral or factorial as an example. 
-->

<h2 id="improve-function-design">Improve function design<a class="headerlink" href="#improve-function-design" title="Permanent link">&para;</a></h2>
<h3 id="read-other-functions">Read other functions<a class="headerlink" href="#read-other-functions" title="Permanent link">&para;</a></h3>
<p>One of the best ways to improve how we write functions is to read other people's functions! Not only do we get to see how others design their functions, we can also learn new and useful functions along the way!</p>
<p>We can access the source code of a function using <code>getAnywhere()</code>:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nf">getAnywhere</span><span class="p">(</span><span class="n">lm</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Some functions may not have directly accessible source code. For example:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nf">getAnywhere</span><span class="p">(</span><span class="n">anova</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Notice that the body of the function consists only of <code>UseMethod("anova")</code>. This is because <code>anova()</code> can take many different kinds of inputs and run different code depending on the input (i.e., it has different <code>methods()</code> for the same function). We can see what those methods are and inspect the source code for any of them:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># What methods are available for anova?</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nf">methods</span><span class="p">(</span><span class="n">anova</span><span class="p">)</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c1"># Inspect anova.lm</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="nf">getAnywhere</span><span class="p">(</span><span class="n">anova.lm</span><span class="p">)</span>
</code></pre></div>
</div>
<p>In some cases, a function could have the same name but are implemented differently because they are part of a different package. For example:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nf">getAnywhere</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To access the <code>filter()</code> source code from the <code>stats</code> package, we need pick one by its index:</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># Get source code for filter in stats package</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="nf">getAnywhere</span><span class="p">(</span><span class="n">filter</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span>
</code></pre></div>
</div>
<h3 id="return-early"><code>return()</code> early<a class="headerlink" href="#return-early" title="Permanent link">&para;</a></h3>
<p>Use <code>return()</code> early in the source code especially if other arguments will lead to more time consuming evaluations. This prevents wasteful use of time and resources to compute variables that will not even be used as outputs!</p>
<h3 id="switch-evaluations-depending-on-argument-input"><code>switch()</code> evaluations depending on argument input<a class="headerlink" href="#switch-evaluations-depending-on-argument-input" title="Permanent link">&para;</a></h3>
<p><code>swtich()</code> is a useful function that evaluates different expressions depending on the argument inputs. It can also be given a default output when no arguments match those specified which can be coded to output a warning or message.</p>
<div class="admonition r-project">
<p class="admonition-title">code</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span>
<span class="normal"><a href="#__codelineno-24-16">16</a></span>
<span class="normal"><a href="#__codelineno-24-17">17</a></span>
<span class="normal"><a href="#__codelineno-24-18">18</a></span>
<span class="normal"><a href="#__codelineno-24-19">19</a></span>
<span class="normal"><a href="#__codelineno-24-20">20</a></span>
<span class="normal"><a href="#__codelineno-24-21">21</a></span>
<span class="normal"><a href="#__codelineno-24-22">22</a></span>
<span class="normal"><a href="#__codelineno-24-23">23</a></span>
<span class="normal"><a href="#__codelineno-24-24">24</a></span>
<span class="normal"><a href="#__codelineno-24-25">25</a></span>
<span class="normal"><a href="#__codelineno-24-26">26</a></span>
<span class="normal"><a href="#__codelineno-24-27">27</a></span>
<span class="normal"><a href="#__codelineno-24-28">28</a></span>
<span class="normal"><a href="#__codelineno-24-29">29</a></span>
<span class="normal"><a href="#__codelineno-24-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="n">calc_alpha_diversity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">log.base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">  </span><span class="c1"># Warn for missing values</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">anyNA</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">    </span><span class="nf">warning</span><span class="p">(</span><span class="s">&quot;x contains NAs which are removed prior to calculations.&quot;</span><span class="p">)</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="w">  </span><span class="c1"># Error on non-numeric and negative data</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.numeric</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">any</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">    </span><span class="nf">stop</span><span class="p">(</span><span class="s">&quot;x must be positive numeric values!&quot;</span><span class="p">)</span>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-24-13" name="__codelineno-24-13"></a>
<a id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="w">  </span><span class="c1"># Richness</span>
<a id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-16" name="__codelineno-24-16"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span>
<a id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-24-18" name="__codelineno-24-18"></a>
<a id="__codelineno-24-19" name="__codelineno-24-19"></a><span class="w">  </span><span class="c1"># Relative frequency</span>
<a id="__codelineno-24-20" name="__codelineno-24-20"></a><span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-24-21" name="__codelineno-24-21"></a>
<a id="__codelineno-24-22" name="__codelineno-24-22"></a><span class="w">  </span><span class="c1"># Indices</span>
<a id="__codelineno-24-23" name="__codelineno-24-23"></a><span class="w">  </span><span class="kr">switch</span><span class="p">(</span>
<a id="__codelineno-24-24" name="__codelineno-24-24"></a><span class="w">    </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="c1"># Value to be matched against in the list below</span>
<a id="__codelineno-24-25" name="__codelineno-24-25"></a><span class="w">    </span><span class="n">shannon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log.base</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span>
<a id="__codelineno-24-26" name="__codelineno-24-26"></a><span class="w">    </span><span class="n">simpson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">),</span>
<a id="__codelineno-24-27" name="__codelineno-24-27"></a><span class="w">    </span><span class="nf">warning</span><span class="p">(</span><span class="s">&quot;Unknown index. Should be one of &#39;richness&#39;, &#39;shannon&#39;, or &#39;simpson&#39;.&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1"># Default output if unmatched</span>
<a id="__codelineno-24-28" name="__codelineno-24-28"></a><span class="w">  </span><span class="p">)</span>
<a id="__codelineno-24-29" name="__codelineno-24-29"></a>
<a id="__codelineno-24-30" name="__codelineno-24-30"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<h3 id="think-of-the-users">Think of the users<a class="headerlink" href="#think-of-the-users" title="Permanent link">&para;</a></h3>
<p><em>Who is the target user for your functions?</em></p>
<p>If it's just you, do whatever you want! However, the fact that you are assigning code to functions implies that you probably want to reuse it for other things/projects or even share them with your colleagues/the world!</p>
<p>If you intend to share your functions with other people/computers/robots, it is important to think about dependencies. Other people will have different set-ups. Thus, it is advisable to write functions using other functions in base R. If you must use other packages, make sure to advise and install early in the script.</p>
<p>While we write functions to be as predictable, elegant, and concise as possible, there are situations where we want to add flexibility. Keep in mind that flexible functions often involve more code. To achieve this, we can write functions that call other custom functions. This is called modularisation. Modular code also helps with troubleshooting, readability, and benchmarking as pieces of it can be tested. This is especially important for production-level code.</p>
<p><em>What stage are you at?</em></p>
<p>Assuming you are writing functions for your analyses, the syntax of your functions are likely geared towards your specific needs at a particular given stage. At the exploratory analysis stage, functions are written with flexbility in mind, perhaps even a little messy or less efficient that it could be.</p>
<p>As you progress to production level code and/or need to use complex processes (permutation tests, sub-sampling, Bayesian methods, etc.), you're likely going to need to think about:</p>
<p><img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /> <strong>Code safety</strong>
Predictable and non-redundant inputs and outpus, and preventing <em>ad inifinitum</em> runs</p>
<p><img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /> <strong>Efficiency</strong>
Use benchmarked algorithms, reduce/remove side effects, parallel processing, reduce overheads</p>
<p><img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /> <strong>Troubleshooting</strong>
Informative errors and warnings, modularised functions</p>
<p><img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /> <strong>Readability</strong>
Commented code, verbose syntax, appropriate assignments (as opposed to long piped processes)</p>
<h3 id="break-your-own-code">Break your own code!<a class="headerlink" href="#break-your-own-code" title="Permanent link">&para;</a></h3>
<p>The best way to learn from your own functions? Break them! How would it handle nonsensical inputs? What are its limits? How much data is too much data? Is it taking seconds, minutes, days to run? We can learn so much about how the function (and R in general) works when we stress test them.</p>
<!--

## I can make those?!

Functions are integral components of R. They are what make it possible to do, well, everything! Even addition `+` is a function: 

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nf">mode</span><span class="p">(</span><span class="n">`+`</span><span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nf">str</span><span class="p">(</span><span class="n">`+`</span><span class="p">)</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>[1] &quot;function&quot;
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>function (e1, e2)
</code></pre></div>

Like all things in R, a function is also an object (we'll see what other implications that has later). Think of functions as verbs. They are pieces of code that do something and produce an outcome (sometimes invisibly). Just as you can assign an object to a variable, you can assign entire chunks of code that "does something" to a object. In R, that is what a function is: an object that does something. So yes, you can write functions! 

In this lesson, we will learn to construct custom functions and conditional statements. Conditional statements are code chunks that helps us handle decision making according to rules. Then, we will write a custom function that calculates different alpha diversity metrics (a staple in any ecological analysis). As part of writing the custom function, we will learn a little bit about defensive programming and how that provides a practical foundation for writing resilient and reliable functions.

## Anatomy of a function

Here is a pseudocode representation of assigning a function:

<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">my_function</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="o">&lt;</span><span class="n">arguments</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">do</span><span class="w"> </span><span class="n">something</span><span class="o">&gt;</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="p">}</span>
</code></pre></div>

All functions start with the `function` call, followed by arguments enveloped between parentheses, and finally the expression (the `<do something>` part of the pseudocode above). This defines what the function does. The expression need not be wrapped in curly brackets `{}` so long as it is on the same line as the `function` call. However, for long expressions, this makes code more legible such that the reader understands that the lines of code wrapped in `{...}` are part of the function object. Here is an example of a function that does $\sqrt{2(x + 1)}$:

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">f1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">))</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="nf">f1</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>[1] 2.828427
</code></pre></div>

!!! tip "`function` shorthand"

    The `function` call can also be shortened to just a backslash `\` to mean the same thing. For example, this is equivalent to the code above:

    !!! r-project "code"

        <div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">f1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span>\<span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">))</span>
</code></pre></div>

    This makes it easier to write short functions on the fly for interactive use.

**Default values**

Many pre-built functions that we use on a day-to-day basis takes one argument as user input. However, this is usually a convenience. For example:

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nf">log</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>[1] 1.609438
</code></pre></div>

By default, the `log()` function returns the natural log (base $e$). If we access its help page, we find that we can specify another base for the logarithm conversion.

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nf">log</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>[1] 1
</code></pre></div>

To set default values for our custom functions, we need only place the value when configuring the arguments. The following function cubes `x` by default, but can take other values to exponentiate `x`.

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">f2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">p</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="nf">f2</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="nf">f2</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>[1] 27
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>[1] 243
</code></pre></div>

## Conditional execution

Before continuing on our journey to write functions, we need to take a brief look at conditional statements. These are common across all programming languages; you may know them as `if-else` statements. They are important constructs that control the flow of operations at all levels, be it within a function or a script, and even across scripts. In their most fundamental form, they resemble this:

<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">predicate</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">expression_1</span><span class="o">&gt;</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">expression_2</span><span class="o">&gt;</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="p">}</span>
</code></pre></div>

The code above means:

> If the predicate returns a TRUE, run code defined by `<expression_1>`, else run `<expression_2>`.

??? note "Predicate and predicate functions"

    A predicate is a statement or function that evaluation that returns **a single** `TRUE` or `FALSE`. For example, this is a predicate that evaluates if `x` is larger than 5:

    <div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">5</span>
</code></pre></div>

    If we set `x <- 10`, the code will return a `TRUE`.

    R has many built-in predicate functions (i.e., functions that evaluate a statement or object and returns a `TRUE`/`FALSE`) are often prefixed using `is.<something>()`. For example:

    !!! r-project "code"

        <div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">9</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">tim</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;Tim is eating&quot;</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">6</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="c1"># Predicate function</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="nf">is.character</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="nf">is.character</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="nf">is.character</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="nf">is.numeric</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</code></pre></div>

        > <div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>[1] FALSE
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>[1] TRUE
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>[1] FALSE
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>[1] TRUE
</code></pre></div>

    Notice that regardless of the length of the vector, the predicate functions return only one Boolean variable. This is important for conditional statements as it can only evaluate predicates and not a vector of Boolean variables.

To better illustrate what conditional statements do, lets construct an `if...else` to evaluate the following question:

Did we recruit enough reads to perform meaningful ecological analyses?

Let's say that a total read count of at least 500 is required for further analysis and that any value lower than or equal to 500 means we must remedy procedures in handling that sample. Here, our predicate is: `sum(<sample_column>) > 500`. 

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">reads_AS1A1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">asv</span><span class="o">$</span><span class="n">AS1A1</span><span class="p">)</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">reads_AS1A1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">500</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">  </span><span class="c1"># If the predicate is TRUE, do this</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">    </span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;This sample has&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reads_AS1A1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;reads.&quot;</span><span class="p">)</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">  </span><span class="p">)</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;It has sufficient reads.&quot;</span><span class="p">)</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">  </span><span class="c1"># If the predicate is FALSE, do this</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;This sample has insufficient reads.&quot;</span><span class="p">)</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="p">}</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>[1] &quot;This sample has 5610 reads.&quot;
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>[1] &quot;It has sufficient reads.&quot;
</code></pre></div>

### Nested statements

If we had multiple predicates that need to be chained one after another, we can construct nested conditional statements:

<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">predicate</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">expression_1</span><span class="o">&gt;</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">predicate</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">expression_2</span><span class="o">&gt;</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">expression_3</span><span class="o">&gt;</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="p">}</span>
</code></pre></div>

For example:

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">reads_S3C3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">asv</span><span class="o">$</span><span class="n">S3C3</span><span class="p">)</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">reads_S3C3</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">reads_S3C3</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">5000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;Abundant reads&quot;</span><span class="p">)</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">reads_S3C3</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">reads_S3C3</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">5000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;High number of reads&quot;</span><span class="p">)</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">reads_S3C3</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">reads_S3C3</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;Sufficient reads&quot;</span><span class="p">)</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;Insufficient reads&quot;</span><span class="p">)</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a><span class="p">}</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>[1] 870
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>[1] &quot;Sufficient reads&quot;
</code></pre></div>

When using nested statements, keep in mind that order matters. This means that if the first predicate is `TRUE`, none of the statements below it will be evaluated.

### Vectorised conditional statements

These are functions that: 

1. Takes a vector of Boolean variables (or an expression that produces them)
2. Returns an outcome for each element if it is TRUE
3. Returns another outcome for each element if it FALSE

For binary decisions (i.e., `if (predicate) {...} else {...}`), there are two functions:

* `ifelse()`: part of base R
* `if_else()`: part of `dplyr`

They can both return short, simple variables:

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="n">read_sums</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">colSums</span><span class="p">(</span><span class="n">asv</span><span class="p">[,</span><span class="w"> </span><span class="m">-1</span><span class="p">])</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="nf">ifelse</span><span class="p">(</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">  </span><span class="n">read_sums</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">5000</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">  </span><span class="s">&quot;Sufficient reads&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">  </span><span class="s">&quot;Insufficient reads&quot;</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">  </span><span class="nf">tail</span><span class="p">()</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>                 AS2C1                  AS2C2                  AS2C3                   S3C1 
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>&quot;Sufficient reads&quot; &quot;Sufficient reads&quot; &quot;Sufficient reads&quot; &quot;Insufficient reads&quot; 
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>                  S3C2                   S3C3 
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>&quot;Insufficient reads&quot;          &quot;Insufficient reads&quot;
</code></pre></div>

or return values after evaluating longer expressions:

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="nf">if_else</span><span class="p">(</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">  </span><span class="n">read_sums</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1000</span><span class="p">,</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">read_sums</span><span class="p">)</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;The square root of this is&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_sums</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">    </span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;The cube root of this is&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="w">  </span><span class="nf">tail</span><span class="p">()</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>                                        AS2C1                                         AS2C2 
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>&quot;The square root of this is 78.4283112147648&quot; &quot;The square root of this is 75.6174583016383&quot; 
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>                                        AS2C3                                          S3C1 
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>&quot;The square root of this is 82.4075239283404&quot; &quot;The square root of this is 33.5111921602321&quot; 
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>                                         S3C2                                          S3C3 
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>&quot;The square root of this is 60.5061980296234&quot;   &quot;The cube root of this is 9.54640270936004&quot;
</code></pre></div>

For nested statements, there is `case_when()` from `dplyr` that takes the form of:

<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="nf">case_when</span><span class="p">(</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">predicate_1</span><span class="o">&gt;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">&lt;</span><span class="n">expression_1</span><span class="o">&gt;</span><span class="p">,</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">predicate_2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">&lt;</span><span class="n">expression_2</span><span class="o">&gt;</span><span class="p">,</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">  </span><span class="o">&lt;</span><span class="n">predicate_3</span><span class="o">&gt;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">&lt;</span><span class="n">expression_3</span><span class="o">&gt;</span><span class="p">,</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">  </span><span class="kc">...</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">  </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">&lt;</span><span class="n">default_value</span><span class="o">&gt;</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="p">)</span>
</code></pre></div>

### Practical usage

**`else` is optional**

For most use cases it is sufficient to only construct the `if (<predicate>) {<expression>}` part of the statement. Unless there is a good reason to pick one option over the other, the `else {<expression>}` is optional and can be entirely omitted. This is because R will only execute the expression within the statement if the predicate is `TRUE`. For this reason, it is very common to see the `else {}` omitted in functions.

**Nested statements are rarely a good idea**

Often, nested statements are not helpful. Nested statements can lead to messy code that ends up being illegible and the results can be cryptic (i.e., the reader may not intuitively know where the results come from based on the chain of statements). 

Sometimes you may have a reason to use nested statements. For example, there may be genuine need for a hierarchical way of evaluating the flow of data where some collection of thresholds warrant a different method of processing data downstream. 

An alternative to nested statements is writing multiple functions which are called under different scenarios. This modular structure means that you not only remove potential redundancies, but it also improves code legibility where readers can easily determine the functions that are being called, the expression the function uses, and the intended result.

**Vectorise for one-off use cases**

R is particularly proficient when we use functions that take in vectors. In cases where you need to `mutate()` a column in a data frame (e.g., replacing values based on pattern searches and return a variable), the vectorised `if_else()` and `case_when()` are your friends. Also, I prefer to use `if_else()` as opposed to `ifelse()` as it can handle missing values and produce consistent output types, a coveted feature in ensuring input-output consistency.

## Functions are objects too

!!! note ""

    This section is a little more abstract than previous sections and might take a while to get our heads around. However, it is nonetheless useful to know how functions can behave like objects so that we can use them more flexibly.

At the beginning of this lesson, we came across the concept that functions are objects. In examples above, we assign names to functions in order to call them. That is one property of an object: *they can be named*. However, there are also objects that we use on the fly without naming them. Consider the following:

<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="nf">c</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;B&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;D&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;F&quot;</span><span class="p">)</span>
</code></pre></div>

If you run the above, it will print out the letters `A`, `B`, `D`, and `F`. We haven't named them, and yet we can use them. The same goes for functions, but the syntax is slightly different:

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="p">(</span>\<span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">)(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>[1] 8
</code></pre></div>

We've encased the function itself in brackets `()`, supplied it with the required arguments, and it provides an output. This is known as an **anonymous function**. Keep this in mind as it will be quite prominent in the next lesson.

Another property of objects is that *they can be stored*. While it is not possible to store a function in a vector, it is possible to store them in a list. This is a valid way to store functions:

<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">flist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">  </span>\<span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="w">  </span>\<span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="p">,</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="w">  </span>\<span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="p">)</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="n">flist</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>[[1]]
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>\(x) x + 1
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>[[2]]
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>\(x) x + 2
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>[[3]]
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>\(x) x ^ 3
</code></pre></div>

With this structure, you can iterate through the list and generate different outputs depending on the function applied.

You can also use it as input to another function. For example, if you pass that into `class()` or `mode()`, it will tell you it is a character vector. When you pass a function into `class()`, it will tell you that it is a function (no surprise there).

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="nf">class</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>[1] &quot;function&quot;
</code></pre></div>

That reveals another aspect of functions: they can be *treated as input*.

We will learn about iterations in the next lesson, but to showcase the points:

* functions can be stored (thus iterated)
* functions can be treated as input

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="nf">map</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span><span class="w"> </span>\<span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="m">2</span><span class="p">))</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>[[1]]
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>[1] 3
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>[[2]]
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>[1] 4
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>[[3]]
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>[1] 8
</code></pre></div>

!!! note "Recursive functions"

    The last property of an object is that for some types, they can exist inside themselves. Consider a nested list:

    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1">1</a></span>
<span class="normal"><a href="#__codelineno-60-2">2</a></span>
<span class="normal"><a href="#__codelineno-60-3">3</a></span>
<span class="normal"><a href="#__codelineno-60-4">4</a></span>
<span class="normal"><a href="#__codelineno-60-5">5</a></span>
<span class="normal"><a href="#__codelineno-60-6">6</a></span>
<span class="normal"><a href="#__codelineno-60-7">7</a></span>
<span class="normal"><a href="#__codelineno-60-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="n">nl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span>\<span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>
<a id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="n">nl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span>
<a id="__codelineno-60-3" name="__codelineno-60-3"></a><span class="w">  </span><span class="n">nl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span>
<a id="__codelineno-60-4" name="__codelineno-60-4"></a><span class="w">    </span><span class="n">nl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span>
<a id="__codelineno-60-5" name="__codelineno-60-5"></a><span class="w">      </span><span class="n">nl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nl</span>
<a id="__codelineno-60-6" name="__codelineno-60-6"></a><span class="w">    </span><span class="p">)</span>
<a id="__codelineno-60-7" name="__codelineno-60-7"></a><span class="w">  </span><span class="p">)</span>
<a id="__codelineno-60-8" name="__codelineno-60-8"></a><span class="p">)</span>
</code></pre></div></td></tr></table></div>

    The above is a list object, in it's own list object, it it's own list object, in it's own list object. Phew what a mouthful! That is a valid structure for an object. Given that functions are also objects, this applies also to functions. When used this way, it is known as a **recursive function** (i.e., a function, that calls itself).

    !!! warning "Use sparingly"

        These constructs often require lots of tinkering and can lead to more problems if they are not coded right. We certainly do not want a function that runs *ad inifinitum*!

    An simple example for this is the factorial. This is defined:

    $$
    n! = n \times (n-1) \times (n-2) \times (n-3) \times ... \times 2 \times 1
    $$

    In code, we can construct:

    !!! r-project "code"

        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1">1</a></span>
<span class="normal"><a href="#__codelineno-61-2">2</a></span>
<span class="normal"><a href="#__codelineno-61-3">3</a></span>
<span class="normal"><a href="#__codelineno-61-4">4</a></span>
<span class="normal"><a href="#__codelineno-61-5">5</a></span>
<span class="normal"><a href="#__codelineno-61-6">6</a></span>
<span class="normal"><a href="#__codelineno-61-7">7</a></span>
<span class="normal"><a href="#__codelineno-61-8">8</a></span>
<span class="normal"><a href="#__codelineno-61-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="n">fr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-3" name="__codelineno-61-3"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">fr</span><span class="p">(</span><span class="n">x</span><span class="m">-1</span><span class="p">)</span>
<a id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<a id="__codelineno-61-6" name="__codelineno-61-6"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-61-7" name="__codelineno-61-7"></a><span class="p">}</span>
<a id="__codelineno-61-8" name="__codelineno-61-8"></a>
<a id="__codelineno-61-9" name="__codelineno-61-9"></a><span class="nf">fr</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

        > <div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>[1] 24
</code></pre></div>

## Code in action: A function for $\alpha$-diversity

### How diverse is a sampled community?

This is likely the first question one asks when considering community ecology of any environment. A direct measure *diversity within a sample* (also known as *$\alpha$-diversity*) is richness (often denoted $q$ or $S$), which is the tally of number of species/taxonomic units present in any given sample. While simple and intuitive, it is heavily influenced by rare taxonomic units (as is often the case in microbiome samples). Therefore, other metrics which account for the *uneven distribution* of taxonomic units are also reported alongside richness. Popular options are:

**Shannon's index, $\textrm{H}$**

$$
\large
\textrm{H} = - \sum_{i=1}^{q} {p_i} \log {p_i}
$$

Where $p_i$ is the proportion of the $i$<sup>th</sup> organism relative to the sample total (also known as the relative frequency of the organism).

**Inverse Simpson's concentration index, $D$**

$$
\large
D = \frac{1}{\lambda}
$$

Where the concentration index $\lambda$ is defined as

$$
\large
\lambda = \sum_{i=1}^{q} {p_i}^2
$$

If you are mathematically inclined, you might observe that these indices give more weight to abundant taxonomic units and that weighting is higher for $D$ than for $\textrm{H}$.

If you are *not* mathematically inclined, or you are busy focusing on learning coding today, don't worry about understanding the math for now - it's enough to know "It's a formula". 

## Step 1: Start small

Lets start by writing a function that calculates richness. Recall that this is the number of taxonomic units present in the sample (i.e., the number of non-zero elements in a numeric vector). We will also create a test vector so we can test our function.

!!! r-project "code"

    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-63-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-63-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-63-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-63-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-63-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-63-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-63-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-63-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-63-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="c1"># Create test vector based on a column in asv</span>
<a id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="n">test_sample</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">asv</span><span class="o">$</span><span class="n">AS1A3</span>
<a id="__codelineno-63-3" name="__codelineno-63-3"></a>
<a id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="c1"># Write richness function</span>
<a id="__codelineno-63-5" name="__codelineno-63-5"></a><span class="n">alpha_diversity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-63-6" name="__codelineno-63-6"></a><span class="w">  </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<a id="__codelineno-63-7" name="__codelineno-63-7"></a><span class="p">}</span>
<a id="__codelineno-63-8" name="__codelineno-63-8"></a>
<a id="__codelineno-63-9" name="__codelineno-63-9"></a><span class="c1"># Test function</span>
<a id="__codelineno-63-10" name="__codelineno-63-10"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_sample</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>[1] 1149
</code></pre></div>

## Step 2: Add arguments as required

We know from the preamble above that $\textrm{H}$ and $D$ are also useful metrics to look at. Lets incorporate them into our function.

!!! r-project "code"

    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-65-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-65-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-65-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-65-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-65-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-65-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-65-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-65-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-65-10">10</a></span>
<span class="normal"><a href="#__codelineno-65-11">11</a></span>
<span class="normal"><a href="#__codelineno-65-12">12</a></span>
<span class="normal"><a href="#__codelineno-65-13">13</a></span>
<span class="normal"><a href="#__codelineno-65-14">14</a></span>
<span class="normal"><a href="#__codelineno-65-15">15</a></span>
<span class="normal"><a href="#__codelineno-65-16">16</a></span>
<span class="normal"><a href="#__codelineno-65-17">17</a></span>
<span class="normal"><a href="#__codelineno-65-18">18</a></span>
<span class="normal"><a href="#__codelineno-65-19">19</a></span>
<span class="normal"><a href="#__codelineno-65-20">20</a></span>
<span class="normal"><a href="#__codelineno-65-21">21</a></span>
<span class="normal"><a href="#__codelineno-65-22">22</a></span>
<span class="normal"><a href="#__codelineno-65-23">23</a></span>
<span class="normal"><a href="#__codelineno-65-24">24</a></span>
<span class="normal"><a href="#__codelineno-65-25">25</a></span>
<span class="normal"><a href="#__codelineno-65-26">26</a></span>
<span class="normal"><a href="#__codelineno-65-27">27</a></span>
<span class="normal"><a href="#__codelineno-65-28">28</a></span>
<span class="normal"><a href="#__codelineno-65-29">29</a></span>
<span class="normal"><a href="#__codelineno-65-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="n">alpha_diversity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-65-2" name="__codelineno-65-2"></a>
<a id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="w">  </span><span class="c1"># Richness</span>
<a id="__codelineno-65-4" name="__codelineno-65-4"></a><span class="w">  </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<a id="__codelineno-65-5" name="__codelineno-65-5"></a>
<a id="__codelineno-65-6" name="__codelineno-65-6"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-65-7" name="__codelineno-65-7"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a id="__codelineno-65-8" name="__codelineno-65-8"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-65-9" name="__codelineno-65-9"></a>
<a id="__codelineno-65-10" name="__codelineno-65-10"></a><span class="w">  </span><span class="c1"># Relative frequency</span>
<a id="__codelineno-65-11" name="__codelineno-65-11"></a><span class="w">  </span><span class="n">p_i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-65-12" name="__codelineno-65-12"></a>
<a id="__codelineno-65-13" name="__codelineno-65-13"></a><span class="w">  </span><span class="c1"># Operation for Shannon&#39;s index</span>
<a id="__codelineno-65-14" name="__codelineno-65-14"></a><span class="w">  </span><span class="c1"># sum(na.rm = TRUE) to account for NAs as a result of log(0)</span>
<a id="__codelineno-65-15" name="__codelineno-65-15"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-65-16" name="__codelineno-65-16"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="nf">sum</span><span class="p">(</span><span class="n">p_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">p_i</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<a id="__codelineno-65-17" name="__codelineno-65-17"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
<a id="__codelineno-65-18" name="__codelineno-65-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-65-19" name="__codelineno-65-19"></a>
<a id="__codelineno-65-20" name="__codelineno-65-20"></a><span class="w">  </span><span class="c1"># Operation for Inverse Simpson&#39;s</span>
<a id="__codelineno-65-21" name="__codelineno-65-21"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-65-22" name="__codelineno-65-22"></a><span class="w">    </span><span class="n">D</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p_i</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">-1</span>
<a id="__codelineno-65-23" name="__codelineno-65-23"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<a id="__codelineno-65-24" name="__codelineno-65-24"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-65-25" name="__codelineno-65-25"></a>
<a id="__codelineno-65-26" name="__codelineno-65-26"></a><span class="p">}</span>
<a id="__codelineno-65-27" name="__codelineno-65-27"></a>
<a id="__codelineno-65-28" name="__codelineno-65-28"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span>
<a id="__codelineno-65-29" name="__codelineno-65-29"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span>
<a id="__codelineno-65-30" name="__codelineno-65-30"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>[1] 1149
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>[1] 6.649886
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>[1] 468.1816
</code></pre></div>

Notice that for shared variables like `p_i`, they are placed outside of conditional statements. This reduces code redundancies. Also, in this step, we are introduced to a new function: `return()`. By default, the function will evaluate all code in its "body" and return the result of the last expression. `return()` literally returns the result of the evaluated expression, regardless of its position in the code.

## Step 3: Refine function

While the function we wrote is pretty good, there are some small improvements we can make:

* **Multiple `return()`** Ideally it should only have one. This is because if the user picks richness, there should be no further evaluation of the function code below richness, thus saving time and computation. Although this function (and the data) is so small that computational efficiency is of minimal concern, the thought of wasteful computation should be part of your function writing consideration.
* **Selection of log bases** Traditionally, the log base of Shannon's index has always been $e$. However, one might want to use a different log base, perhaps as a comparison against another study which uses a different base.
* **Redundant variables** While the notation of $\textrm{H}$ and $D$ is useful to us in differentiating the indices in mathematical notation, it is a redundancy in the code. The decision to return either indices is already managed by the conditional statements. 

!!! r-project "code"

    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-67-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-67-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-67-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-67-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-67-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-67-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-67-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-67-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-67-10">10</a></span>
<span class="normal"><a href="#__codelineno-67-11">11</a></span>
<span class="normal"><a href="#__codelineno-67-12">12</a></span>
<span class="normal"><a href="#__codelineno-67-13">13</a></span>
<span class="normal"><a href="#__codelineno-67-14">14</a></span>
<span class="normal"><a href="#__codelineno-67-15">15</a></span>
<span class="normal"><a href="#__codelineno-67-16">16</a></span>
<span class="normal"><a href="#__codelineno-67-17">17</a></span>
<span class="normal"><a href="#__codelineno-67-18">18</a></span>
<span class="normal"><a href="#__codelineno-67-19">19</a></span>
<span class="normal"><a href="#__codelineno-67-20">20</a></span>
<span class="normal"><a href="#__codelineno-67-21">21</a></span>
<span class="normal"><a href="#__codelineno-67-22">22</a></span>
<span class="normal"><a href="#__codelineno-67-23">23</a></span>
<span class="normal"><a href="#__codelineno-67-24">24</a></span>
<span class="normal"><a href="#__codelineno-67-25">25</a></span>
<span class="normal"><a href="#__codelineno-67-26">26</a></span>
<span class="normal"><a href="#__codelineno-67-27">27</a></span>
<span class="normal"><a href="#__codelineno-67-28">28</a></span>
<span class="normal"><a href="#__codelineno-67-29">29</a></span>
<span class="normal"><a href="#__codelineno-67-30">30</a></span>
<span class="normal"><a href="#__codelineno-67-31">31</a></span>
<span class="normal"><a href="#__codelineno-67-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="n">alpha_diversity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-67-2" name="__codelineno-67-2"></a>
<a id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="w">  </span><span class="c1"># Richness</span>
<a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="w">  </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<a id="__codelineno-67-5" name="__codelineno-67-5"></a>
<a id="__codelineno-67-6" name="__codelineno-67-6"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-67-7" name="__codelineno-67-7"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a id="__codelineno-67-8" name="__codelineno-67-8"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-67-9" name="__codelineno-67-9"></a>
<a id="__codelineno-67-10" name="__codelineno-67-10"></a><span class="w">  </span><span class="c1"># Relative frequency</span>
<a id="__codelineno-67-11" name="__codelineno-67-11"></a><span class="w">  </span><span class="n">p_i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-67-12" name="__codelineno-67-12"></a>
<a id="__codelineno-67-13" name="__codelineno-67-13"></a><span class="w">  </span><span class="c1"># Operation for Shannon&#39;s index</span>
<a id="__codelineno-67-14" name="__codelineno-67-14"></a><span class="w">  </span><span class="c1"># sum(na.rm = TRUE) to account for NAs as a result of log(0)</span>
<a id="__codelineno-67-15" name="__codelineno-67-15"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-67-16" name="__codelineno-67-16"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="nf">sum</span><span class="p">(</span><span class="n">p_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<a id="__codelineno-67-17" name="__codelineno-67-17"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-67-18" name="__codelineno-67-18"></a>
<a id="__codelineno-67-19" name="__codelineno-67-19"></a><span class="w">  </span><span class="c1"># Operation for Inverse Simpson&#39;s</span>
<a id="__codelineno-67-20" name="__codelineno-67-20"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-67-21" name="__codelineno-67-21"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p_i</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">-1</span>
<a id="__codelineno-67-22" name="__codelineno-67-22"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-67-23" name="__codelineno-67-23"></a>
<a id="__codelineno-67-24" name="__codelineno-67-24"></a><span class="w">  </span><span class="c1"># Return result</span>
<a id="__codelineno-67-25" name="__codelineno-67-25"></a><span class="w">  </span><span class="n">H</span>
<a id="__codelineno-67-26" name="__codelineno-67-26"></a>
<a id="__codelineno-67-27" name="__codelineno-67-27"></a><span class="p">}</span>
<a id="__codelineno-67-28" name="__codelineno-67-28"></a>
<a id="__codelineno-67-29" name="__codelineno-67-29"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span>
<a id="__codelineno-67-30" name="__codelineno-67-30"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span>
<a id="__codelineno-67-31" name="__codelineno-67-31"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<a id="__codelineno-67-32" name="__codelineno-67-32"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>[1] 1149
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>[1] 6.649886
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>[1] 9.593758
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>[1] 468.1816
</code></pre></div>

## Step 4: Defend function

Our function has held up well under ideal conditions. Let's imagine using this function under less than ideal scenarios (dirty data, incorrect types, etc.). What are some of the pitfalls you can think of with the function we wrote?

??? warning "Possible pitfalls"

    1. While we have guarded our function against `NA`s resulting from `log(0)`, there remains the problem of negative numbers. Both richness and Simpson index will continue to be calculated without error or warning, even if it does not make sense to do so.
    2. If the data was supposed to be numeric but was read incorrectly and coerced to become a character, how would we handle that?
    3. How would we handle missing values in general?

To address these concerns, we will take hints from a concept called **defensive programming**. An aspect of defensive programming is preventing incorrect usage of code by "failing fast". This is where errors are produced and code will stop running if inputs are incorrect or do not make sense. In practice, that means we need to be strict with inputs and how they are to be pre-processed. We also need to balance this with the prospect that users know what they are doing and provide flexible implementation when needed. 

In this case, we need to address:

!!! success "Improvements to make"

    1. Negative numbers makes no sense for the calculation of richness and relative frequencies. Therefore, we must insist on the provision of strictly zero or positive numbers as inputs and produce an error that stops further code execution if a negative number is found.
    2. Regardless of the reason for non-numeric inputs, calculations only make sense for numeric data. This is non-negotiable. Thus, we must write code the produces an error if non-numeric inputs are detected.
    3. We can be flexible around missing values. For these indices, there is no way to differentiate a missing observation versus a zero count. Therefore, we can warn the user that there are missing values and that they are removed prior to calculation.

!!! r-project "code"

    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-69-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-69-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-69-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-69-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-69-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-69-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-69-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-69-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-69-10">10</a></span>
<span class="normal"><a href="#__codelineno-69-11">11</a></span>
<span class="normal"><a href="#__codelineno-69-12">12</a></span>
<span class="normal"><a href="#__codelineno-69-13">13</a></span>
<span class="normal"><a href="#__codelineno-69-14">14</a></span>
<span class="normal"><a href="#__codelineno-69-15">15</a></span>
<span class="normal"><a href="#__codelineno-69-16">16</a></span>
<span class="normal"><a href="#__codelineno-69-17">17</a></span>
<span class="normal"><a href="#__codelineno-69-18">18</a></span>
<span class="normal"><a href="#__codelineno-69-19">19</a></span>
<span class="normal"><a href="#__codelineno-69-20">20</a></span>
<span class="normal"><a href="#__codelineno-69-21">21</a></span>
<span class="normal"><a href="#__codelineno-69-22">22</a></span>
<span class="normal"><a href="#__codelineno-69-23">23</a></span>
<span class="normal"><a href="#__codelineno-69-24">24</a></span>
<span class="normal"><a href="#__codelineno-69-25">25</a></span>
<span class="normal"><a href="#__codelineno-69-26">26</a></span>
<span class="normal"><a href="#__codelineno-69-27">27</a></span>
<span class="normal"><a href="#__codelineno-69-28">28</a></span>
<span class="normal"><a href="#__codelineno-69-29">29</a></span>
<span class="normal"><a href="#__codelineno-69-30">30</a></span>
<span class="normal"><a href="#__codelineno-69-31">31</a></span>
<span class="normal"><a href="#__codelineno-69-32">32</a></span>
<span class="normal"><a href="#__codelineno-69-33">33</a></span>
<span class="normal"><a href="#__codelineno-69-34">34</a></span>
<span class="normal"><a href="#__codelineno-69-35">35</a></span>
<span class="normal"><a href="#__codelineno-69-36">36</a></span>
<span class="normal"><a href="#__codelineno-69-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1"></a><span class="n">alpha_diversity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">metric</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-69-2" name="__codelineno-69-2"></a>
<a id="__codelineno-69-3" name="__codelineno-69-3"></a><span class="w">  </span><span class="c1"># Warns for missing values</span>
<a id="__codelineno-69-4" name="__codelineno-69-4"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">anyNA</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-69-5" name="__codelineno-69-5"></a><span class="w">    </span><span class="nf">warning</span><span class="p">(</span><span class="s">&quot;x contains missing values. These were removed prior to calculations.&quot;</span><span class="p">)</span>
<a id="__codelineno-69-6" name="__codelineno-69-6"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
<a id="__codelineno-69-7" name="__codelineno-69-7"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-69-8" name="__codelineno-69-8"></a>
<a id="__codelineno-69-9" name="__codelineno-69-9"></a><span class="w">  </span><span class="c1"># Ensure positive numeric inputs</span>
<a id="__codelineno-69-10" name="__codelineno-69-10"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.numeric</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">any</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-69-11" name="__codelineno-69-11"></a><span class="w">    </span><span class="nf">stop</span><span class="p">(</span><span class="s">&quot;x must be positive numeric values!&quot;</span><span class="p">)</span>
<a id="__codelineno-69-12" name="__codelineno-69-12"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-69-13" name="__codelineno-69-13"></a>
<a id="__codelineno-69-14" name="__codelineno-69-14"></a><span class="w">  </span><span class="c1"># Richness</span>
<a id="__codelineno-69-15" name="__codelineno-69-15"></a><span class="w">  </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<a id="__codelineno-69-16" name="__codelineno-69-16"></a>
<a id="__codelineno-69-17" name="__codelineno-69-17"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-69-18" name="__codelineno-69-18"></a><span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<a id="__codelineno-69-19" name="__codelineno-69-19"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-69-20" name="__codelineno-69-20"></a>
<a id="__codelineno-69-21" name="__codelineno-69-21"></a><span class="w">  </span><span class="c1"># Relative frequency</span>
<a id="__codelineno-69-22" name="__codelineno-69-22"></a><span class="w">  </span><span class="n">p_i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-69-23" name="__codelineno-69-23"></a>
<a id="__codelineno-69-24" name="__codelineno-69-24"></a><span class="w">  </span><span class="c1"># Operation for Shannon&#39;s index</span>
<a id="__codelineno-69-25" name="__codelineno-69-25"></a><span class="w">  </span><span class="c1"># sum(na.rm = TRUE) to account for NAs as a result of log(0)</span>
<a id="__codelineno-69-26" name="__codelineno-69-26"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-69-27" name="__codelineno-69-27"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="nf">sum</span><span class="p">(</span><span class="n">p_i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<a id="__codelineno-69-28" name="__codelineno-69-28"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-69-29" name="__codelineno-69-29"></a>
<a id="__codelineno-69-30" name="__codelineno-69-30"></a><span class="w">  </span><span class="c1"># Operation for Inverse Simpson&#39;s</span>
<a id="__codelineno-69-31" name="__codelineno-69-31"></a><span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-69-32" name="__codelineno-69-32"></a><span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">p_i</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">-1</span>
<a id="__codelineno-69-33" name="__codelineno-69-33"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-69-34" name="__codelineno-69-34"></a>
<a id="__codelineno-69-35" name="__codelineno-69-35"></a><span class="w">  </span><span class="n">H</span>
<a id="__codelineno-69-36" name="__codelineno-69-36"></a>
<a id="__codelineno-69-37" name="__codelineno-69-37"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>

    We will also generate some new test vectors to simulate problematic inputs of missing values, negative numbers or character values.

    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1">1</a></span>
<span class="normal"><a href="#__codelineno-70-2">2</a></span>
<span class="normal"><a href="#__codelineno-70-3">3</a></span>
<span class="normal"><a href="#__codelineno-70-4">4</a></span>
<span class="normal"><a href="#__codelineno-70-5">5</a></span>
<span class="normal"><a href="#__codelineno-70-6">6</a></span>
<span class="normal"><a href="#__codelineno-70-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1"></a><span class="n">test_missing</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span>
<a id="__codelineno-70-2" name="__codelineno-70-2"></a><span class="n">test_negative</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span><span class="w"> </span><span class="m">-46</span><span class="p">)</span>
<a id="__codelineno-70-3" name="__codelineno-70-3"></a><span class="n">test_character</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">test_sample</span><span class="p">)</span>
<a id="__codelineno-70-4" name="__codelineno-70-4"></a>
<a id="__codelineno-70-5" name="__codelineno-70-5"></a><span class="nf">tail</span><span class="p">(</span><span class="n">test_missing</span><span class="p">)</span>
<a id="__codelineno-70-6" name="__codelineno-70-6"></a><span class="nf">tail</span><span class="p">(</span><span class="n">test_negative</span><span class="p">)</span>
<a id="__codelineno-70-7" name="__codelineno-70-7"></a><span class="nf">tail</span><span class="p">(</span><span class="n">test_character</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>[1]  0  0  0  0 NA NA
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>[1]   0   0   0   0   0 -46
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>[1] &quot;0&quot; &quot;0&quot; &quot;0&quot; &quot;0&quot; &quot;0&quot; &quot;0&quot;
</code></pre></div>

    Now test the new function:

    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1">1</a></span>
<span class="normal"><a href="#__codelineno-72-2">2</a></span>
<span class="normal"><a href="#__codelineno-72-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_missing</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;richness&quot;</span><span class="p">)</span>
<a id="__codelineno-72-2" name="__codelineno-72-2"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_negative</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;shannon&quot;</span><span class="p">)</span>
<a id="__codelineno-72-3" name="__codelineno-72-3"></a><span class="nf">alpha_diversity</span><span class="p">(</span><span class="n">test_character</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;simpson&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>[1] 1149
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>Warning message:
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>In alpha_diversity(test_missing, &quot;richness&quot;) :
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>  x contains missing values. These were removed prior to calculations.
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>Error in alpha_diversity(test_negative, &quot;shannon&quot;) : 
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>  x must be positive numeric values!
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>Error in alpha_diversity(test_character, &quot;simpson&quot;) : 
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>  x must be positive numeric values!
</code></pre></div>

## Improving function writing

**Read existing functions (i.e., other people's code)**

This is often the best way to improve how you write functions. You can inspect the code for most functions by calling the function name without the brackets:

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># Looking at the source code for the function that calculates an interquartile range</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="n">IQR</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a>function (x, na.rm = FALSE, type = 7) 
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>diff(quantile(as.numeric(x), c(0.25, 0.75), na.rm = na.rm, names = FALSE, 
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>    type = type))
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>&lt;bytecode: 0x0000023a58a9af60&gt;
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>&lt;environment: namespace:stats&gt;
</code></pre></div>


Some functions are handled differently depending on the input. If we call the functions directly like above, we might get this output:

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="n">anova</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>function (object, ...) 
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>UseMethod(&quot;anova&quot;)
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>&lt;bytecode: 0x0000023a3f9e4838&gt;
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>&lt;environment: namespace:stats&gt;
</code></pre></div>

In this case, use a combination of `methods()` and `getAnywhere()` to find the source code.

!!! r-project "code"

    <div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="nf">methods</span><span class="p">(</span><span class="s">&quot;anova&quot;</span><span class="p">)</span>
</code></pre></div>

    > <div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a>[1] anova.glm*     anova.glmlist* anova.lm*      anova.lmlist*  anova.loess*   anova.mlm*     anova.mlmlist*
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>[8] anova.nls*    
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>see &#39;?methods&#39; for accessing help and source code
</code></pre></div>
    Pick one of the outputs as the input for `getAnywhere()`.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="nf">getAnywhere</span><span class="p">(</span><span class="s">&quot;anova.lm&quot;</span><span class="p">)</span>
</code></pre></div>
    > <div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>A single object matching ‘anova.lm’ was found
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>It was found in the following places
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>  registered S3 method for anova from namespace stats
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>  namespace:stats
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>with value
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>function (object, ...) 
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>{
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>    if (length(list(object, ...)) &gt; 1L) 
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>        return(anova.lmlist(object, ...))
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>    if (!inherits(object, &quot;lm&quot;)) 
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>        warning(&quot;calling anova.lm(&lt;fake-lm-object&gt;) ...&quot;)
<a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>    w &lt;- object$weights
<a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a>    ssr &lt;- sum(if (is.null(w)) object$residuals^2 else w * object$residuals^2)
<a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a>    mss &lt;- sum(if (is.null(w)) object$fitted.values^2 else w * 
<a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a>        object$fitted.values^2)
<a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a>    if (ssr &lt; 1e-10 * mss) 
<a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a>        warning(&quot;ANOVA F-tests on an essentially perfect fit are unreliable&quot;)
<a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a>    dfr &lt;- df.residual(object)
<a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a>    p &lt;- object$rank
<a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a>    if (p &gt; 0L) {
<a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a>        p1 &lt;- 1L:p
<a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a>        comp &lt;- object$effects[p1]
<a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a>        asgn &lt;- object$assign[qr.lm(object)$pivot][p1]
<a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a>        nmeffects &lt;- c(&quot;(Intercept)&quot;, attr(object$terms, &quot;term.labels&quot;))
<a id="__codelineno-81-26" name="__codelineno-81-26" href="#__codelineno-81-26"></a>        tlabels &lt;- nmeffects[1 + unique(asgn)]
<a id="__codelineno-81-27" name="__codelineno-81-27" href="#__codelineno-81-27"></a>        ss &lt;- c(vapply(split(comp^2, asgn), sum, 1), ssr)
<a id="__codelineno-81-28" name="__codelineno-81-28" href="#__codelineno-81-28"></a>        df &lt;- c(lengths(split(asgn, asgn)), dfr)
<a id="__codelineno-81-29" name="__codelineno-81-29" href="#__codelineno-81-29"></a>    }
<a id="__codelineno-81-30" name="__codelineno-81-30" href="#__codelineno-81-30"></a>    else {
<a id="__codelineno-81-31" name="__codelineno-81-31" href="#__codelineno-81-31"></a>        ss &lt;- ssr
<a id="__codelineno-81-32" name="__codelineno-81-32" href="#__codelineno-81-32"></a>        df &lt;- dfr
<a id="__codelineno-81-33" name="__codelineno-81-33" href="#__codelineno-81-33"></a>        tlabels &lt;- character()
<a id="__codelineno-81-34" name="__codelineno-81-34" href="#__codelineno-81-34"></a>    }
<a id="__codelineno-81-35" name="__codelineno-81-35" href="#__codelineno-81-35"></a>    ms &lt;- ss/df
<a id="__codelineno-81-36" name="__codelineno-81-36" href="#__codelineno-81-36"></a>    f &lt;- ms/(ssr/dfr)
<a id="__codelineno-81-37" name="__codelineno-81-37" href="#__codelineno-81-37"></a>    P &lt;- pf(f, df, dfr, lower.tail = FALSE)
<a id="__codelineno-81-38" name="__codelineno-81-38" href="#__codelineno-81-38"></a>    table &lt;- data.frame(df, ss, ms, f, P)
<a id="__codelineno-81-39" name="__codelineno-81-39" href="#__codelineno-81-39"></a>    table[length(P), 4:5] &lt;- NA
<a id="__codelineno-81-40" name="__codelineno-81-40" href="#__codelineno-81-40"></a>    dimnames(table) &lt;- list(c(tlabels, &quot;Residuals&quot;), c(&quot;Df&quot;, 
<a id="__codelineno-81-41" name="__codelineno-81-41" href="#__codelineno-81-41"></a>        &quot;Sum Sq&quot;, &quot;Mean Sq&quot;, &quot;F value&quot;, &quot;Pr(&gt;F)&quot;))
<a id="__codelineno-81-42" name="__codelineno-81-42" href="#__codelineno-81-42"></a>    if (attr(object$terms, &quot;intercept&quot;)) 
<a id="__codelineno-81-43" name="__codelineno-81-43" href="#__codelineno-81-43"></a>        table &lt;- table[-1, ]
<a id="__codelineno-81-44" name="__codelineno-81-44" href="#__codelineno-81-44"></a>    structure(table, heading = c(&quot;Analysis of Variance Table\n&quot;, 
<a id="__codelineno-81-45" name="__codelineno-81-45" href="#__codelineno-81-45"></a>        paste(&quot;Response:&quot;, deparse(formula(object)[[2L]]))), 
<a id="__codelineno-81-46" name="__codelineno-81-46" href="#__codelineno-81-46"></a>        class = c(&quot;anova&quot;, &quot;data.frame&quot;))
<a id="__codelineno-81-47" name="__codelineno-81-47" href="#__codelineno-81-47"></a>}
<a id="__codelineno-81-48" name="__codelineno-81-48" href="#__codelineno-81-48"></a>&lt;bytecode: 0x0000025be02abf58&gt;
<a id="__codelineno-81-49" name="__codelineno-81-49" href="#__codelineno-81-49"></a>&lt;environment: namespace:stats&gt;
</code></pre></div>

The output tells us that there is a function called `anova.lm` within the package `stats` with the function as defined in the body. 

??? tip "Why the different options for `anova()`?"

    Some functions can produce different outputs depending on input type (or class). We used `anova()` as an example as the Analysis of Variance can be performed on the outputs of different models: linear, generalised linear, compare multiple models, etc (read the help page for `lm()` and you will find that there is a statement under the **Value** section: `lm returns an object of class "lm" or for multivariate (‘multiple’) responses of class c("mlm", "lm").`). However, different classes of models require different calculation to perform the same kind of analysis. Therefore, instead of storing multiple dizzying `if...else` statements (the body of the function is sufficiently voluminous!), the different functions are stored as `methods` for the different `class`. This means that whenever we call `anova()` with an input that was generated using a `glm()`, it will detect that the input carries the `class` of `glm` and dispatch (read: use) the appropriate `method` to handle it.

**Write according to needs**

We strive to write functions to be as predictable and elegant as possible. However, this is only a guide. Depending on our needs, the syntax of our functions can and should change. If we are at the stage of exploratory data analysis, we should be coding for flexibility. At this early stage, if things do fail, it is not a dependency issue and we can troubleshoot as needed. Furthermore, if we are testing code on smaller data sets, we do not need to be as mindful of being computationally efficient. However, as we get ready to scale our analyses workflows that have input-output dependencies (i.e., production level code), we need to change our priorities. Here, the priorities should be code safety (predictable In/Oout, no code running *ad infinitum*, redundancies in checking I/O,), efficiency (i.e., use efficient and benchmarked algorithms/functions/packages, avoid code that produced side effects), ease of troubleshooting (i.e., use modular abstractions, informative error and warning messages), and readability (i.e., commented code, reduce shorthands if possible).

**Break them!**

There is no better way to know what our functions are doing than by purposefully breaking them. What would happen if we provided a nonsense input? Will it produce a valid output? Will it error out? In addition, stress testing functions (especially complex ones) is helpful. Are there portions of the code that is inefficient/stalling? How much data is too much data? When writing multiple functions (some of which might be dependent on each other), this can help us to identify weaknesses and improper use.

-->












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../2.relational_data/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Relational data">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Relational data
              </div>
            </div>
          </a>
        
        
          
          <a href="../4.iterations/" class="md-footer__link md-footer__link--next" aria-label="Next: Iterations">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Iterations
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Intermediate-R workshop material is licensed under a <a rel="noopener" target="_blank" href="https://www.gnu.org/licenses/gpl-3.0.en.html">GNU General Public License v3.0</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer", "content.code.copy", "content.code.annotate"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>